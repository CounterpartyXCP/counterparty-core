# Keep this as non-docker for now, to give some variety to our test configurations, as travis builds with docker
dependencies:
    cache_directories:
        - ./webthree-umbrella*
    override:
        # Install ethereum dependencies
        # NEW PACKAGES TO BUILD `solc`
        # from http://www.ethdocs.org/en/latest/ethereum-clients/cpp-ethereum/building-from-source/linux-ubuntu.html
        - sudo add-apt-repository universe
        - sudo apt-add-repository -y ppa:george-edison55/cmake-3.x
        - sudo apt-get -y update && sudo apt-get -y install language-pack-en-base gcc-4.8 software-properties-common
        - sudo add-apt-repository -y ppa:ethereum/ethereum
        - sudo add-apt-repository -y ppa:ethereum/ethereum-dev
        - sudo apt-get -y --allow-unauthenticated update
        - cat /etc/apt/sources.list
        - cat /etc/apt/sources.list.d/*
        - sudo apt-get -y install build-essential cmake libboost-all-dev libgmp-dev \
                             libleveldb-dev libminiupnpc-dev libreadline-dev libncurses5-dev \
                             libcurl4-openssl-dev libcryptopp-dev libmicrohttpd-dev libjsoncpp-dev \
                             libargtable2-dev libedit-dev mesa-common-dev ocl-icd-libopencl1 opencl-headers \
                             libgoogle-perftools-dev ocl-icd-dev libv8-dev libz-dev
        - sudo apt-get -y install libjson-rpc-cpp-dev || sudo apt-get -y install libjsonrpccpp-dev
        - rm -rf /home/ubuntu/virtualenvs/venv-*/bin/serpent
        - rm -rf /home/ubuntu/virtualenvs/venv-*/lib/python3.4/site-packages/apsw*
        - pip install -r requirements.txt
        - python setup.py install --with-serpent --with-solc
        - python -c "import apsw; print(apsw.apswversion())"
        - ./bin/solc --version
        - git submodule update --init
test:
    override:
        - py.test --verbose --capture=no counterpartylib/test/config_context_test.py
        - py.test --verbose --capture=no counterpartylib/test/unit_test.py
        - py.test --verbose --capture=no counterpartylib/test/utxolocks_test.py
        - py.test --verbose --capture=no counterpartylib/test/bytespersigop_test.py
        - py.test --verbose --capture=no counterpartylib/test/hashlib_test.py
        - py.test --verbose --capture=no counterpartylib/test/parse_block_test.py
        - py.test --verbose --capture=no counterpartylib/test/integration_test.py
        - py.test --verbose --capture=no counterpartylib/test/hashlib_test.py
        - py.test --verbose --capture=no counterpartylib/test/utxolocks_test.py
        - py.test --verbose --capture=no counterpartylib/test/evm/
        - py.test --verbose --capture=no --skiptestbook=mainnet -k test_book counterpartylib/test/reparse_test.py
        - py.test --verbose --capture=no --skiptestbook=testnet -k test_book counterpartylib/test/reparse_test.py
        - py.test --verbose --capture=no counterpartylib/test/database_version_test.py
machine:
    pre:
        - mkdir -p ~/.local/share/counterparty;
        - wget https://s3.amazonaws.com/counterparty-bootstrap/counterparty-db-testnet.latest.tar.gz -O ~/.local/share/counterparty/counterparty-db-testnet.latest.tar.gz;
        - tar -C ~/.local/share/counterparty -xvzf ~/.local/share/counterparty/counterparty-db-testnet.latest.tar.gz;
        - wget https://s3.amazonaws.com/counterparty-bootstrap/counterparty-db.latest.tar.gz -O ~/.local/share/counterparty/counterparty-db.latest.tar.gz;
        - tar -C ~/.local/share/counterparty -xvzf ~/.local/share/counterparty/counterparty-db.latest.tar.gz;
    python:
        version: 3.4.1
