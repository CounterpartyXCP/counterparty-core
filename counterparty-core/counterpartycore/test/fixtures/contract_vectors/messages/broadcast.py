from counterpartycore.lib import config
from counterpartycore.test.fixtures.params import ADDR, DP, P2SH_ADDR

BROADCAST_VECTOR = {
    "broadcast": {
        "validate": [
            {
                "in": (
                    ADDR[0],
                    1588000000,
                    1,
                    DP["fee_multiplier"],
                    "Unit Test",
                    DP["default_block_index"],
                ),
                "out": ([]),
            },
            {
                "in": (
                    P2SH_ADDR[0],
                    1588000000,
                    1,
                    DP["fee_multiplier"],
                    "Unit Test",
                    DP["default_block_index"],
                ),
                "out": ([]),
            },
            {
                "in": (
                    ADDR[2],
                    1588000000,
                    1,
                    DP["fee_multiplier"],
                    "Unit Test",
                    DP["default_block_index"],
                ),
                "out": (["locked feed"]),
            },
            {
                "in": (
                    ADDR[0],
                    1588000000,
                    1,
                    4294967296,
                    "Unit Test",
                    DP["default_block_index"],
                ),
                "out": (["fee fraction greater than or equal to 1"]),
            },
            {
                "in": (
                    ADDR[0],
                    -1388000000,
                    1,
                    DP["fee_multiplier"],
                    "Unit Test",
                    DP["default_block_index"],
                ),
                "out": (["negative timestamp", "feed timestamps not monotonically increasing"]),
            },
            {
                "in": (
                    None,
                    1588000000,
                    1,
                    DP["fee_multiplier"],
                    "Unit Test",
                    DP["default_block_index"],
                ),
                "out": (["null source address"]),
            },
            {
                "comment": "test changing options to ADDRESS_OPTION_MAX_VALUE + 1 on a specific address",
                "mock_protocol_changes": {"enhanced_sends": True, "options_require_memo": True},
                "in": (
                    ADDR[5],
                    1588000000,
                    1,
                    DP["fee_multiplier"],
                    "OPTIONS %i" % (config.ADDRESS_OPTION_MAX_VALUE + 1),
                    DP["default_block_index"],
                ),
                "out": (["options out of range"]),
            },
            {
                "comment": "test changing options to -1 on a specific address",
                "mock_protocol_changes": {"enhanced_sends": True, "options_require_memo": True},
                "in": (
                    ADDR[5],
                    1588000000,
                    1,
                    DP["fee_multiplier"],
                    "OPTIONS -1",
                    DP["default_block_index"],
                ),
                "out": (["options integer overflow"]),
            },
            {
                "comment": "test changing options to non-int on a specific address",
                "mock_protocol_changes": {"enhanced_sends": True, "options_require_memo": True},
                "in": (
                    ADDR[5],
                    1588000000,
                    1,
                    DP["fee_multiplier"],
                    "OPTIONS XCP",
                    DP["default_block_index"],
                ),
                "out": (["options not an integer"]),
            },
        ],
        "compose": [
            {
                "comment": "test old text packing for short text",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (ADDR[0], 1588000000, 1, DP["fee_multiplier"], "Unit Test"),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00LK@\tUnit Test",
                ),
            },
            {
                "in": (P2SH_ADDR[0], 1588000000, 1, DP["fee_multiplier"], "Unit Test"),
                "out": (
                    P2SH_ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00LK@\tUnit Test",
                ),
            },
            {
                "comment": "test old text packing for 51 chars",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (
                    ADDR[0],
                    1588000000,
                    1,
                    0,
                    "Exactly 51 characters test test test test test tes.",
                ),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x003Exactly 51 characters test test test test test tes.",
                ),
            },
            {
                "comment": "test old text packing for 52 chars",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (
                    ADDR[0],
                    1588000000,
                    1,
                    0,
                    "Exactly 52 characters test test test test test test.",
                ),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x004Exactly 52 characters test test test test test test.",
                ),
            },
            {
                "comment": "test old text packing for 53 chars",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (
                    ADDR[0],
                    1588000000,
                    1,
                    0,
                    "Exactly 53 characters test test test test test testt.",
                ),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00Exactly 53 characters test test test test test testt.",
                ),
            },
            {
                "comment": "test old text packing for string with utf-8 char, "
                "THIS IS A BUG! but for consensus reasons we want to keep it in tact! the length byte should be 1 higher",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (ADDR[0], 1588000000, 1, 0, "This is an e with an: è."),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18This is an e with an: \xc3\xa8",
                ),
            },
            {
                "comment": "test old text packing for LOCK",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (ADDR[0], 1388000100, 50000000, 0, "LOCK"),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1eR\xbb3dA\x87\xd7\x84\x00\x00\x00\x00\x00\x00\x00\x00\x04LOCK",
                ),
            },
            {
                "comment": "test current text packing for short text",
                "in": (ADDR[0], 1588000000, 1, DP["fee_multiplier"], "Unit Test"),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00LK@\tUnit Test",
                ),
            },
            {
                "comment": "test current text packing for 51 chars",
                "in": (
                    ADDR[0],
                    1588000000,
                    1,
                    0,
                    "Exactly 51 characters test test test test test tes.",
                ),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x003Exactly 51 characters test test test test test tes.",
                ),
            },
            {
                "comment": "test current text packing for 52 chars",
                "in": (
                    ADDR[0],
                    1588000000,
                    1,
                    0,
                    "Exactly 52 characters test test test test test test.",
                ),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x004Exactly 52 characters test test test test test test.",
                ),
            },
            {
                "comment": "test current text packing for 53 chars",
                "in": (
                    ADDR[0],
                    1588000000,
                    1,
                    0,
                    "Exactly 53 characters test test test test test testt.",
                ),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x005Exactly 53 characters test test test test test testt.",
                ),
            },
            {
                "comment": "test current text packing for string with utf-8 char",
                "in": (ADDR[0], 1588000000, 1, 0, "This is an e with an: è."),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x19This is an e with an: \xc3\xa8.",
                ),
            },
            {
                "comment": "test current text packing for LOCK",
                "in": (ADDR[0], 1388000100, 50000000, 0, "LOCK"),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1eR\xbb3dA\x87\xd7\x84\x00\x00\x00\x00\x00\x00\x00\x00\x04LOCK",
                ),
            },
            {
                "in": (
                    ADDR[0],
                    1588000000,
                    1,
                    DP["fee_multiplier"],
                    "Over 80 characters test test test test test test test test test test test test test test test test test test",
                ),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00LK@lOver 80 characters test test test test test test test test test test test test test test test test test test",
                ),
            },
            {
                "comment": "test current text packing for 'OPTIONS 1'",
                "in": (ADDR[0], 1388000100, 50000000, 0, "OPTIONS 1"),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1eR\xbb3dA\x87\xd7\x84\x00\x00\x00\x00\x00\x00\x00\x00\tOPTIONS 1",
                ),
            },
            {
                "comment": "test current text packing for 'OPTIONS 0'",
                "in": (ADDR[0], 1388000100, 50000000, 0, "OPTIONS 0"),
                "out": (
                    ADDR[0],
                    [],
                    b"\x00\x00\x00\x1eR\xbb3dA\x87\xd7\x84\x00\x00\x00\x00\x00\x00\x00\x00\tOPTIONS 0",
                ),
            },
        ],
        "parse": [
            {
                "comment": "test old text unpacking for short text",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (
                    {
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "supported": 1,
                        "data": b"\x00\x00\x00\x1eR\xbb3dA\x87\xd7\x84\x00\x00\x00\x00\x00\x00\x00\x00\x06BARFOO",
                        "fee": 10000,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "btc_amount": 0,
                        "block_time": 310501000,
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 0,
                            "locked": 0,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": "BARFOO",
                            "timestamp": 1388000100,
                            "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                            "tx_index": DP["default_tx_index"],
                            "value": 50000000.0,
                        },
                    },
                ],
            },
            {
                "comment": "test old text unpacking for 51 chars",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (
                    {
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "supported": 1,
                        "data": b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x003Exactly 51 characters test test test test test tes.",
                        "fee": 10000,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "btc_amount": 0,
                        "block_time": 310501000,
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 0,
                            "locked": 0,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": "Exactly 51 characters test test test test test tes.",
                            "timestamp": 1588000000,
                            "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                            "tx_index": DP["default_tx_index"],
                            "value": 1.0,
                        },
                    },
                ],
            },
            {
                "comment": "test old text unpacking for 52 chars, "
                "THIS IS A BUG! but for consensus reasons we want to keep it in tact! the '4' from the length byte is added to the stored text",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (
                    {
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "supported": 1,
                        "data": b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x004Exactly 52 characters test test test test test test.",
                        "fee": 10000,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "btc_amount": 0,
                        "block_time": 310501000,
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 0,
                            "locked": 0,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": "4Exactly 52 characters test test test test test test.",
                            "timestamp": 1588000000,
                            "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                            "tx_index": DP["default_tx_index"],
                            "value": 1.0,
                        },
                    },
                ],
            },
            {
                "comment": "test old text unpacking for 53 chars",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (
                    {
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "supported": 1,
                        "data": b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00Exactly 53 characters test test test test test testt.",
                        "fee": 10000,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "btc_amount": 0,
                        "block_time": 310501000,
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 0,
                            "locked": 0,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": "Exactly 53 characters test test test test test testt.",
                            "timestamp": 1588000000,
                            "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                            "tx_index": DP["default_tx_index"],
                            "value": 1.0,
                        },
                    },
                ],
            },
            {
                "comment": "test old text packing for string with utf-8 char, "
                "THIS IS A BUG! but for consensus reasons we want to keep it in tact! the . is trimmed off because of a bad length byte",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (
                    {
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "supported": 1,
                        "data": b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18This is an e with an: \xc3\xa8.",
                        "fee": 10000,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "btc_amount": 0,
                        "block_time": 310501000,
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 0,
                            "locked": 0,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": "This is an e with an: è",
                            "timestamp": 1588000000,
                            "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                            "tx_index": DP["default_tx_index"],
                            "value": 1.0,
                        },
                    },
                ],
            },
            {
                "comment": "test old text unpacking for bet",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (
                    {
                        "fee": 10000,
                        "btc_amount": 0,
                        "supported": 1,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "block_time": 310501000,
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "source": "mn6q3dS2EnDUx3bmyWc6D4szJNVGtaR7zc",
                        "tx_hash": "c9e8db96d520b0611218504801e74796ae4f476578512d21d3f99367ab8e356f",
                        "data": b"\x00\x00\x00\x1eR\xbb4,\xc0\x00\x00\x00\x00\x00\x00\x00\x00LK@\tUnit Test",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 5000000,
                            "locked": 0,
                            "source": "mn6q3dS2EnDUx3bmyWc6D4szJNVGtaR7zc",
                            "status": "valid",
                            "text": "Unit Test",
                            "timestamp": 1388000300,
                            "tx_hash": "c9e8db96d520b0611218504801e74796ae4f476578512d21d3f99367ab8e356f",
                            "tx_index": DP["default_tx_index"],
                            "value": -2.0,
                        },
                    },
                    {
                        "table": "bets",
                        "values": {
                            "bet_type": 3,
                            "block_index": DP["default_block_index"],
                            "counterwager_quantity": 10,
                            "counterwager_remaining": 10,
                            "deadline": 1388000200,
                            "expiration": 1000,
                            "expire_index": 311101,
                            "fee_fraction_int": 5000000,
                            "feed_address": "mn6q3dS2EnDUx3bmyWc6D4szJNVGtaR7zc",
                            "leverage": 5040,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "dropped",
                            "target_value": 0.0,
                            "tx_hash": "7a2ab30a4e996078632806cebc56e62cc6b04ce45a027394faa6e3dee71bf886",
                            "tx_index": 102,
                            "wager_quantity": 10,
                            "wager_remaining": 10,
                        },
                    },
                ],
            },
            {
                "comment": "test old text unpacking for LOCK",
                "mock_protocol_changes": {"broadcast_pack_text": False},
                "in": (
                    {
                        "btc_amount": 0,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "fee": 10000,
                        "supported": 1,
                        "block_time": 310501000,
                        "tx_hash": "6b4a62b80f35b0e66df4591c8a445d453d995609e2df12afe93e742bea10dd86",
                        "tx_index": DP["default_tx_index"],
                        "data": b"\x00\x00\x00\x1eR\xbb3dA\x87\xd7\x84\x00\x00\x00\x00\x00\x00\x00\x00\x04LOCK",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": None,
                            "locked": 1,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": None,
                            "timestamp": 0,
                            "tx_hash": "6b4a62b80f35b0e66df4591c8a445d453d995609e2df12afe93e742bea10dd86",
                            "tx_index": DP["default_tx_index"],
                            "value": None,
                        },
                    }
                ],
            },
            {
                "comment": "test current text unpacking for short text",
                "in": (
                    {
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "supported": 1,
                        "data": b"\x00\x00\x00\x1eR\xbb3dA\x87\xd7\x84\x00\x00\x00\x00\x00\x00\x00\x00\x06BARFOO",
                        "fee": 10000,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "btc_amount": 0,
                        "block_time": 310501000,
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 0,
                            "locked": 0,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": "BARFOO",
                            "timestamp": 1388000100,
                            "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                            "tx_index": DP["default_tx_index"],
                            "value": 50000000.0,
                        },
                    },
                ],
            },
            {
                "comment": "test current text unpacking for 51 chars",
                "in": (
                    {
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "supported": 1,
                        "data": b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x003Exactly 51 characters test test test test test tes.",
                        "fee": 10000,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "btc_amount": 0,
                        "block_time": 310501000,
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 0,
                            "locked": 0,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": "Exactly 51 characters test test test test test tes.",
                            "timestamp": 1588000000,
                            "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                            "tx_index": DP["default_tx_index"],
                            "value": 1.0,
                        },
                    },
                ],
            },
            {
                "comment": "test current text unpacking for 52 chars",
                "in": (
                    {
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "supported": 1,
                        "data": b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x004Exactly 52 characters test test test test test test.",
                        "fee": 10000,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "btc_amount": 0,
                        "block_time": 310501000,
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 0,
                            "locked": 0,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": "Exactly 52 characters test test test test test test.",
                            "timestamp": 1588000000,
                            "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                            "tx_index": DP["default_tx_index"],
                            "value": 1.0,
                        },
                    },
                ],
            },
            {
                "comment": "test current text unpacking for 53 chars, ",
                "in": (
                    {
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "supported": 1,
                        "data": b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x005Exactly 53 characters test test test test test testt.",
                        "fee": 10000,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "btc_amount": 0,
                        "block_time": 310501000,
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 0,
                            "locked": 0,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": "Exactly 53 characters test test test test test testt.",
                            "timestamp": 1588000000,
                            "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                            "tx_index": DP["default_tx_index"],
                            "value": 1.0,
                        },
                    },
                ],
            },
            {
                "comment": "test current text packing for string with utf-8 char, ",
                "in": (
                    {
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "supported": 1,
                        "data": b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x19This is an e with an: \xc3\xa8.",
                        "fee": 10000,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "btc_amount": 0,
                        "block_time": 310501000,
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 0,
                            "locked": 0,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": "This is an e with an: è.",
                            "timestamp": 1588000000,
                            "tx_hash": "dd48da950fd7d000224b79ebe3495fa594ca6d6698f16c4e2dc93b4f116006ea",
                            "tx_index": DP["default_tx_index"],
                            "value": 1.0,
                        },
                    },
                ],
            },
            {
                "comment": "test current text unpacking for bet",
                "in": (
                    {
                        "fee": 10000,
                        "btc_amount": 0,
                        "supported": 1,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "block_time": 310501000,
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "source": "mn6q3dS2EnDUx3bmyWc6D4szJNVGtaR7zc",
                        "tx_hash": "c9e8db96d520b0611218504801e74796ae4f476578512d21d3f99367ab8e356f",
                        "data": b"\x00\x00\x00\x1eR\xbb4,\xc0\x00\x00\x00\x00\x00\x00\x00\x00LK@\tUnit Test",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 5000000,
                            "locked": 0,
                            "source": "mn6q3dS2EnDUx3bmyWc6D4szJNVGtaR7zc",
                            "status": "valid",
                            "text": "Unit Test",
                            "timestamp": 1388000300,
                            "tx_hash": "c9e8db96d520b0611218504801e74796ae4f476578512d21d3f99367ab8e356f",
                            "tx_index": DP["default_tx_index"],
                            "value": -2.0,
                        },
                    },
                    {
                        "table": "bets",
                        "values": {
                            "bet_type": 3,
                            "block_index": DP["default_block_index"],
                            "counterwager_quantity": 10,
                            "counterwager_remaining": 10,
                            "deadline": 1388000200,
                            "expiration": 1000,
                            "expire_index": 311101,
                            "fee_fraction_int": 5000000,
                            "feed_address": "mn6q3dS2EnDUx3bmyWc6D4szJNVGtaR7zc",
                            "leverage": 5040,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "dropped",
                            "target_value": 0.0,
                            "tx_hash": "7a2ab30a4e996078632806cebc56e62cc6b04ce45a027394faa6e3dee71bf886",
                            "tx_index": 102,
                            "wager_quantity": 10,
                            "wager_remaining": 10,
                        },
                    },
                ],
            },
            {
                "comment": "attempt to cancel bet on LOCKED feed, should keep bet open",
                "in": (
                    {
                        "fee": 10000,
                        "btc_amount": 0,
                        "supported": 1,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "tx_index": DP["default_tx_index"],
                        "block_time": 310501000,
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "source": ADDR[4],
                        "tx_hash": "c9e8db96d520b0611218504801e74796ae4f476578512d21d3f99367ab8e356f",
                        "data": b"\x00\x00\x00\x1eR\xbb4,\xc0\x00\x00\x00\x00\x00\x00\x00\x00LK@\tUnit Test",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 5000000,
                            "locked": 0,
                            "source": ADDR[4],
                            "status": "invalid: locked feed",
                            "text": "Unit Test",
                            "timestamp": 1388000300,
                            "tx_hash": "c9e8db96d520b0611218504801e74796ae4f476578512d21d3f99367ab8e356f",
                            "tx_index": DP["default_tx_index"],
                            "value": -2.0,
                        },
                    },
                    {
                        "table": "bets",
                        "values": {
                            "bet_type": 1,
                            "block_index": 310487,
                            "counterwager_quantity": 9,
                            "counterwager_remaining": 9,
                            "deadline": 1388000001,
                            "expiration": 100,
                            "expire_index": 310587,
                            "fee_fraction_int": 5000000,
                            "feed_address": ADDR[4],
                            "leverage": 5040,
                            "source": ADDR[4],
                            "status": "open",
                            "target_value": 0.0,
                            "tx_hash": "d25fbc4a7396c0ce2e13b49a652b4804c991d1a7bbeb265a5139b9510aa8c9b6",
                            "tx_index": 488,
                            "wager_quantity": 9,
                            "wager_remaining": 9,
                        },
                    },
                ],
            },
            {
                "comment": "test current text unpacking for LOCK",
                "in": (
                    {
                        "btc_amount": 0,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "fee": 10000,
                        "supported": 1,
                        "block_time": 310501000,
                        "tx_hash": "6b4a62b80f35b0e66df4591c8a445d453d995609e2df12afe93e742bea10dd86",
                        "tx_index": DP["default_tx_index"],
                        "data": b"\x00\x00\x00\x1eR\xbb3dA\x87\xd7\x84\x00\x00\x00\x00\x00\x00\x00\x00\x04LOCK",
                    },
                ),
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": None,
                            "locked": 1,
                            "source": "mtQheFaSfWELRB2MyMBaiWjdDm6ux9Ezns",
                            "status": "valid",
                            "text": None,
                            "timestamp": 0,
                            "tx_hash": "6b4a62b80f35b0e66df4591c8a445d453d995609e2df12afe93e742bea10dd86",
                            "tx_index": DP["default_tx_index"],
                            "value": None,
                        },
                    }
                ],
            },
            {
                "comment": "test changing options to 1 on a specific address",
                "mock_protocol_changes": {"enhanced_sends": True, "options_require_memo": True},
                "in": (
                    {
                        "btc_amount": 0,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "source": ADDR[5],
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "fee": 10000,
                        "supported": 1,
                        "block_time": 310501000,
                        "tx_hash": "6b4a62b80f35b0e66df4591c8a445d453d995609e2df12afe93e742bea10dd86",
                        "tx_index": DP["default_tx_index"],
                        "data": b"\x00\x00\x00\x1eR\xbb3dA\x87\xd7\x84\x00\x00\x00\x00\x00\x00\x00\x00\tOPTIONS 1",
                    },
                ),
                "records": [{"table": "addresses", "values": {"options": 1, "address": ADDR[5]}}],
            },
            {
                "comment": "test changing options to 1 on an address with LOCKED feed",
                "mock_protocol_changes": {"enhanced_sends": True, "options_require_memo": True},
                "in": (
                    {
                        "btc_amount": 1,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "source": ADDR[4],
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "fee": 10000,
                        "supported": 1,
                        "block_time": 310501000,
                        "tx_hash": "6b4a62b80f35b0e66df4591c8a445d453d995609e2df12afe93e742bea10dd86",
                        "tx_index": DP["default_tx_index"],
                        "data": b"\x00\x00\x00\x1eR\xbb3dA\x87\xd7\x84\x00\x00\x00\x00\x00\x00\x00\x00\tOPTIONS 1",
                    },
                ),
                "out": None,
                "records": [{"table": "addresses", "values": {"options": 0, "address": ADDR[4]}}],
            },
            {
                "comment": "test malformed message with incorrect length",
                "mock_protocol_changes": {"broadcast_pack_text": True},
                "in": (
                    {
                        "btc_amount": 1,
                        "block_hash": "46ac6d09237c7961199068fdd13f1508d755483e07c57a4c8f7ff18eb33a05c93ca6a86fa2e2af82fb77a5c337146bb37e279797a3d11970aec4693c46ea5a58",
                        "source": ADDR[4],
                        "destination": "",
                        "block_index": DP["default_block_index"],
                        "fee": 10000,
                        "supported": 1,
                        "block_time": 310501000,
                        "tx_hash": "6b4a62b80f35b0e66df4591c8a445d453d995609e2df12afe93e742bea10dd86",
                        "tx_index": DP["default_tx_index"],
                        "data": b"\x00\x00\x00\x1e^\xa6\xf5\x00?\xf0\x00\x00\x00\x00\x00\x00\x00LK@#A 28 CHARACTERS LONG TEXT",
                    },
                ),
                "out": None,
                "records": [
                    {
                        "table": "broadcasts",
                        "values": {
                            "block_index": DP["default_block_index"],
                            "fee_fraction_int": 0,
                            "locked": 0,
                            "source": ADDR[4],
                            "status": "invalid: could not unpack text",
                            "text": None,
                            "timestamp": 0,
                            "tx_hash": "6b4a62b80f35b0e66df4591c8a445d453d995609e2df12afe93e742bea10dd86",
                            "tx_index": DP["default_tx_index"],
                            "value": None,
                        },
                    }
                ],
            },
        ],
    },
}
