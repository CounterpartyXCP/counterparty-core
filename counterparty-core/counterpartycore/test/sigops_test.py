import tempfile

from bitcoinutils.transactions import Transaction

from counterpartycore.lib import composer
from counterpartycore.test.fixtures.params import ADDR, DP  # noqa: F401
from counterpartycore.test.util_test import CURR_DIR

FIXTURE_SQL_FILE = CURR_DIR + "/fixtures/scenarios/unittest_fixture.sql"
FIXTURE_DB = tempfile.gettempdir() + "/fixtures.unittest_fixture.db"


def test_sigops_count():
    # bc9384919ad5d08b2c66e31f29e7c63572c398a87631c03a4ce9e94ff1cbe62f
    # segwit input -> segwit output
    tx_hex = "01000000000101982a1221773c5aba2be5c6290229023281b1774428a5d280b8c15499368056661b00000017160014e83d1d02a3844c34995ec3fc1ef0b49bf02936f5ffffffff01a0b8c900000000001976a914645e1f9be127080712ae9cd36fb2e65b3121060088ac024730440220012432fdcc626510bd77815257bdcf761db2608c76281176fc5a2fa4ed60cda402205061c264051b7811891af1bc802d0ef770dbbc1d5f63fd9bb6902e76653125e60121020ebf45fb179f47e9d818219903069dcff3e3b4c51641f69000610a4c07fb5a0d00000000"
    tx = Transaction.from_raw(tx_hex)
    selected_utxos = [
        {
            "txid": "665680369954c1b880d2a5284477b1813202290229c6e52bba5a3c7721122a98",
            "vout": 27,
            "script_pub_key": "a9145479813889d9026541cdd297a0aa5dd954d4365b87",
        }
    ]
    assert composer.get_size_info(tx, selected_utxos, signed=True) == (136, 136, 5)

    # 598adf5eddc0787c5d09c67b00df46fb9639659f3873f8afff32a5cedbf98ebf
    # segwit input -> segwit output
    tx_hex = "02000000000101911c185f040030407c904b4991a844a4494c26a28d7b29cc86134ec69001e6e90000000000fdffffff017823360c00000000160014d584f88ec3b200e4115e715f7edde287776006120247304402207fb79a106ba2ec21b4c7f30ba73b7356a60055752956c608e89e7a52ce12bfd2022031c8efa6fa8d14d3bd00ddd4777fea526bfc160802c58c0c1f3f6849c317d84d012103edf275f41337c9c6350b36539cf82260b4c926cd93f38e562e5adc60f6670e8143640d00"
    tx = Transaction.from_raw(tx_hex)
    selected_utxos = [
        {
            "txid": "e9e60190c64e1386cc297b8da2264c49a444a891494b907c403000045f181c91",
            "vout": 0,
            "script_pub_key": "00147277a7e315011fa7d878af066e10b72478590ca1",
        }
    ]
    assert composer.get_size_info(tx, selected_utxos, signed=True) == (110, 110, 1)

    # e5a1cf0cb04c3651e64bf341d3b3ea129d26a35f63bde31d0b8a6e80c1736a22
    # legacy input -> legacy output + segwit output
    tx_hex = "0100000008ec782851d410722d97c4b13fbb95ba14cfac9e9a0bceef43c2b5848529a1241c560000006a473044022037228cbd1d9d20a86aecc55befef072de59fe4eedda265849a7287606c2e6b1002206b8c49e39760d856ba00fdbc2809d8509d09215fad7efcb61086e5e86b3c19ee01210241a12b88d94507d92885403150126a55eaa2fb38b0912da706b242e2a808b45afdffffff84c2165c4d9aa6ab5ce4b4cb1dfb1b2ecc019ccfa1b6642866b822c92dde172a460000006a47304402201d2a7da8d597b967f50ee312821d372c7275dcdd86ffd5d2fa8fc59bead140080220184da8fb930a9a6650b429bef3af37b9956ba7369660cb59246323bcea1d950301210241a12b88d94507d92885403150126a55eaa2fb38b0912da706b242e2a808b45afdffffff7a712c7da7f756577482aab61d46d419c1ad77a31512ce18e1ba51377485d6cf4a0000006a4730440220444f2d41a94e8ef7676e50cd9c0b87dd0dd32b11bed9e533c478f0607f0bdc2802202127a067d95b09e5e3ce7fa587ef6d5b2df6e85a8eb266e5170cb0f942c3c30501210241a12b88d94507d92885403150126a55eaa2fb38b0912da706b242e2a808b45afdffffff11e8c9351e4edfd99a9858aea94bebfb902b5482d18da361ef1736a21499cc830b0000006a47304402206ce5ab18f70a7318800e0e24fa945ff5569e766bca121adcf7735a6985556b0b02204bc3cc024db1a072d19baeafdac097bdf067fcf2bfabafdec1924671a9554b6a01210241a12b88d94507d92885403150126a55eaa2fb38b0912da706b242e2a808b45afdffffffdaacdf8d8a45372ee6d0006949133f74f5bd2e1b50e217348aafc111b23309bf300000006a47304402202be975814bbd77c4502d624c9f15d7dec8fee1aa999aee2174430e727ede7fdf022003be894122d422871dda0520d823825c4741b2ccb4db0538a532e5eda46c209f01210241a12b88d94507d92885403150126a55eaa2fb38b0912da706b242e2a808b45afdffffffa74ccffb5220dd9dcd2b1bc9a7ec70011e331e5bc19749330825fb47ba9d37a5a20000006a473044022051e40c746cbe4bb382b6b4fa31d4dc73f83fc5b623beacc90783f1a592b4e3c002201ff36fabe2e18fbd2a4a0160c9ee6c5b9dc0fe597e67dc4c798b5a4445e70c1201210241a12b88d94507d92885403150126a55eaa2fb38b0912da706b242e2a808b45afdfffffff1b904f0ab6d0e49bb2c1f85d128d224fbd5d6804f5384d48ba1fe86a3e92bd4a20000006a4730440220558e1a79139d17282e32ca8103d0c2f4cd37dc7255cfd31e93b6112824645fff022032bff32c3065b13480714d1129fe72e5a647de6e6610939ea85c8117dfe0b1c101210241a12b88d94507d92885403150126a55eaa2fb38b0912da706b242e2a808b45afdffffff1b6fb33bcbf99c65e4a4dbdf3d026a7ad1e2a6a296681dc36ccb321ac61052cba80000006a4730440220476acc5b5ced17d59d724eb739135b3c255c60c85c4a028e318839c4a2b824e00220115b58982b19f1bd49b65673e7b50adaf3fab605e8c6797e4981cbf47850d6d001210241a12b88d94507d92885403150126a55eaa2fb38b0912da706b242e2a808b45afdffffff02a4121c00000000001976a914dc3def004f9ad05d4d0fc3b23a7ab44f2102fd5188ac002d3101000000001600144f6b3f34c3a7290413a034fff4c09fdef19d2e4100000000"
    tx = Transaction.from_raw(tx_hex)
    selected_utxos = [
        {
            "txid": "1c24a1298584b5c243efce0b9a9eaccf14ba95bb3fb1c4972d7210d4512878ec",
            "vout": 86,
            "script_pub_key": "76a914673c5b8e2e7d25bfa24d6cfdf4078cc3460e501088ac",
        },
        {
            "txid": "2a17de2dc922b8662864b6a1cf9c01cc2e1bfb1dcbb4e45caba69a4d5c16c284",
            "vout": 70,
            "script_pub_key": "76a914673c5b8e2e7d25bfa24d6cfdf4078cc3460e501088ac",
        },
        {
            "txid": "cfd685743751bae118ce1215a377adc119d4461db6aa82745756f7a77d2c717a",
            "vout": 74,
            "script_pub_key": "76a914673c5b8e2e7d25bfa24d6cfdf4078cc3460e501088ac",
        },
        {
            "txid": "83cc9914a23617ef61a38dd182542b90fbeb4ba9ae58989ad9df4e1e35c9e811",
            "vout": 11,
            "script_pub_key": "76a914673c5b8e2e7d25bfa24d6cfdf4078cc3460e501088ac",
        },
        {
            "txid": "bf0933b211c1af8a3417e2501b2ebdf5743f13496900d0e62e37458a8ddfacda",
            "vout": 48,
            "script_pub_key": "76a914673c5b8e2e7d25bfa24d6cfdf4078cc3460e501088ac",
        },
        {
            "txid": "a5379dba47fb2508334997c15b1e331e0170eca7c91b2bcd9ddd2052fbcf4ca7",
            "vout": 162,
            "script_pub_key": "76a914673c5b8e2e7d25bfa24d6cfdf4078cc3460e501088ac",
        },
        {
            "txid": "d42be9a386fea18bd484534f80d6d5fb24d228d1851f2cbb490e6dabf004b9f1",
            "vout": 162,
            "script_pub_key": "76a914673c5b8e2e7d25bfa24d6cfdf4078cc3460e501088ac",
        },
        {
            "txid": "cb5210c61a32cb6cc31d6896a2a6e2d17a6a023ddfdba4e4659cf9cb3bb36f1b",
            "vout": 168,
            "script_pub_key": "76a914673c5b8e2e7d25bfa24d6cfdf4078cc3460e501088ac",
        },
    ]
    assert composer.get_size_info(tx, selected_utxos, signed=True) == (1251, 1251, 4)

    # 3558a1a100b89f50608ce46a0e90f49d3c0c6f6ee4b204748d57243d7e4e53fc
    # legacy input -> opreturn output + legacy output
    tx_hex = "02000000012970ac142b2eca71f3702ce42a30e5b390ac8109aedb551934b3a7d262a4ef3c000000006b483045022100b6774a8aad7792a18d8584285bf14d4e961df04f02b054da2877d78caae2ea8b02203ada32c54423cf5374efe545254496487107aba3d0acde07e1e7ac374c4cb2ac01210234ff78c2726fb1ab2238db8b586efffdc7f577981053a5aea1fb3963527a347fffffffff020000000000000000306a2e22f8b90f458f8a77bbe1e50c49e82addc91897910063983ec690599e7fe7a3a45ba9cab73455e81e13eb75010f4aac840100000000001976a914ae8222d073a8fcfe24021484dddbae72a8307f6a88ac00000000"
    tx = Transaction.from_raw(tx_hex)
    selected_utxos = [
        {
            "txid": "3cefa462d2a7b3341955dbae0981ac90b3e5302ae42c70f371ca2e2b14ac7029",
            "vout": 0,
            "script_pub_key": "76a914ae8222d073a8fcfe24021484dddbae72a8307f6a88ac",
        }
    ]
    assert composer.get_size_info(tx, selected_utxos, signed=True) == (249, 249, 4)

    # 9eaaadc946e8bd6502f3a99220fb22fc613a24960bf52622425bd2b237d93d38
    # legacy input -> multisig output + legacy output
    tx_hex = "0100000002a77887272e139cc0c8f6b8b003a19eeb191dc0f8a13e5cf3614c04609783acdd010000006b483045022100e43216b5be8200c50d34645b0751322ab077d5574711be37da36719174d3776c022072e129d4e635b441d9ba9d47bc9dd2089c032cefc1325b2e76e424cf9aed3bc60121021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09acffffffff5336838dd6c5ee1d773c07149770ced865c2b2709580f1fb2e63b5388c295a90010000006b483045022100f443ff2fe4c9a974a6399eb9349afdd8c99db9c810308c887fd3f1eaf68fd7fb022004d406bfcb8dfa0a015619c940444f30b21f640b7b47a355aa638647ff329f150121021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09acffffffff0ce8030000000000006951210361886315e46a4ca5ffa68e17c66c4da01795a9521dae3c39578cd5de54c7dd5f2102eb225587684295bf74b33873bebbce47a715ea43cb9623b33134062e87c0b29121021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09ac53aee8030000000000006951210261886315e46a4ca5ff9ad856144d1fcb6ee29b10249d490834d47a8b07d1954a2103ee3f4c95740ed9f735b1224892eb830af656a310d5c072e664642802ebaec14521021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09ac53aee8030000000000006951210261886315e46a4ca5ff9ac5266f6938c179e1c026648c061967f104e674d29e612102f42204c82414d1e43dba776ab1bd8d06f415b402c4d572e664645178919fa76f21021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09ac53aee8030000000000006951210361886315e46a4ca5ff8cdc347828789222a19c6b28cc085d63b51ca36388ca2f2103aa7045c134149ba576aa6e6080a0c108ee17e256848d69ec68664729d199cdc321021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09ac53aee8030000000000006951210261886315e46a4ca5ffd79c726f226d903bb58b3069cd635a3fed46a1339ec53b2102b97512cb3d0f87a974ea7877bc96c94fb115ea43858460ec68664739c48de6f121021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09ac53aee8030000000000006951210361886315e46a4ca5ffca88683e792ed47efac770278e1e0966bc18f6668ccf3f2102a97647c5330e8fb266ff2866eefa9649b707b35bd68232e426765578c4cbab8c21021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09ac53aee8030000000000006951210361886315e46a4ca5ffdd8c647c217cc474a5cf6a7c9f0f5c62ef4ef5608dcb1d2103fa7712c4340f80bd67a97967bbf99e1ae407e053808569eb72275c7a919ca57721021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09ac53aee8030000000000006951210361886315e46a4ca5ff8cdf3e2820289025f190602d9a085f64ba1bf2348899942103aa701593350482e360ab7936bcaacd4eec0fb100d6d236ba2220032d95c8a27e21021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09ac53aee8030000000000006951210261886315e46a4ca5ff88d9367d287d9027a599622d9e0c0966be1ea7678ccec32102ff7f13c53d0784e062fe2237bea8974cb051e502808068ed7d72077894c3a25021021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09ac53aee8030000000000006951210261886315e46a4ca5ff80df627d287e9027a599622d9e0c0967bd11f160ddc6f32102a87340c530008fe06cad2a31bbf09d1ae003b650868764be7020567c969ba32421021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09ac53aee803000000000000695121027e886315e46a4ca5ff8adc60797b2e9574f6cb3625965d5a67bc18f6668ccff42103a9655b8f0436b78554c81a03dfc9af2ad437d063b0b450dc4446654ba5fa92be21021720dc2e2365f6dec79744b692e9c3e561906acd0b47a7382429efbe8d3b09ac53ae89590700000000001976a914f7468e8e02d92044f3634b4f373a125f4cc5ccbd88ac00000000"
    tx = Transaction.from_raw(tx_hex)
    selected_utxos = [
        {
            "txid": "ddac839760044c61f35c3ea1f8c01d19eb9ea103b0b8f6c8c09c132e278778a7",
            "vout": 1,
            "script_pub_key": "76a914f7468e8e02d92044f3634b4f373a125f4cc5ccbd88ac",
        },
        {
            "txid": "905a298c38b5632efbf1809570b2c265d8ce709714073c771deec5d68d833653",
            "vout": 1,
            "script_pub_key": "76a914f7468e8e02d92044f3634b4f373a125f4cc5ccbd88ac",
        },
    ]
    assert composer.get_size_info(tx, selected_utxos, signed=True) == (4420, 1594, 884)

    # 4ecb2667294f5694629fc17dd1ec95087125af44372b46958ff47fe2476f1c0a
    # segwit input -> op_return output + segwit output
    tx_hex = "020000000001010e19545f5987c06385d31dc5672fbad9c82c60383c7ccccae81f746a8ed100f00400000000fdffffff0200000000000000003c6a3ab05f911468b62997f8af9b77e5d939f22496e23a3e9fa72537e3065e278c351e540762065daf1101b8b9abfc910ebf17c940ad370a09e1cd5c2b12a3030000000000160014807c3e0589bd35991a990a4058678957a137ab460248304502210087ccfc3ba8b9627a7da47d0295f1f8c89426c0d8cb7cd246b3f1185de4f3139c02201776192b1aae5f6bc05b43f91a27750fde35f599d0968167dcf0c0e0424a411e0121032310a8d197323b9e3407e8f032ea5b85249e31eaee5ae0ac7db27d76df2538d000000000"
    tx = Transaction.from_raw(tx_hex)
    selected_utxos = [
        {
            "txid": "f000d18e6a741fe8cacc7c3c38602cc8d9ba2f67c51dd38563c087595f54190e",
            "vout": 4,
            "script_pub_key": "0014807c3e0589bd35991a990a4058678957a137ab46",
        }
    ]
    assert composer.get_size_info(tx, selected_utxos, signed=True) == (179, 179, 1)

    # 16d2a285e9db2ec1364f7d8c2293c99abbff7f805e9bd116a0ba34b4f569b923
    # segwit input -> multisig output + segwit output
    tx_hex = "020000000001019ab51dec20ef06572489bd48772f254a40c656ff2b99c7fa54f790bc9ea55fee0100000000ffffffff04e80300000000000069512102646fcd4e1bba4d406395d1709e29cfe1b33de44f9f9b1598bd0263ce4c0391ee2102fba49c17e222b718b3a649ac1bcf143568545213d415594c5aa363fc9b93bf0721022a58f4bc199c871f622692c3bc6b94b46577294a357346d549267a8947678af353aee80300000000000069512102646fcd4e1bba4d4063670af7a2ec5354d0634510f131c1b47f0b6ef17a5de1fd210264d59cdee619a0131fec03eba098e10e9e8bb2ce8f8090ccd5f6a3894c41584821022a58f4bc199c871f622692c3bc6b94b46577294a357346d549267a8947678af353aee803000000000000695121034a6fcd4e1bba4d406396d5339e829a21ed344ea86e4091a4d3cb16d8c570295c210264d59cdea19f2c1273b83a8ade41b4749e8bb2ce8f8090ccf1f6a3894c41580e21022a58f4bc199c871f622692c3bc6b94b46577294a357346d549267a8947678af353aeb10b02000000000016001450efc3efc606c7891caef1aed700ed4e204be2b302483045022100b1acc9fca64b4a588276971a745b8613b3f534b5214b60c6590790b981bdeb38022071dbd4ea2d365eb971e3535b4c19d81d6e7eea65df6577294dbcfff16f16278d0121022a58f4bc199c871f622692c3bc6b94b46577294a357346d549267a8947678af300000000"
    tx = Transaction.from_raw(tx_hex)
    selected_utxos = [
        {
            "txid": "ee5fa59ebc90f754fac7992bff56c6404a252f7748bd89245706ef20ec1db59a",
            "vout": 1,
            "script_pub_key": "001450efc3efc606c7891caef1aed700ed4e204be2b3",
        }
    ]
    assert composer.get_size_info(tx, selected_utxos, signed=True) == (1205, 452, 241)
